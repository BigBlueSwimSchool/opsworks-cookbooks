#!/bin/bash
# chkconfig: 2345 95 20

. /etc/init.d/functions

NAME=app-service
SOURCE_DIR=/var/www/api/$NAME/
SOURCE_FILE=server.js
SOCK_FILE=/var/run/node/app.sock
APP=$SOURCE_DIR$SOURCE_FILE

user=root
pidfile=/var/run/$NAME.pid
logfile=/var/log/$NAME-forever.log
forever_dir=/var/run/forever
forever=forever

start() {
  # Create the log and pid files, making sure that
  # the target use has access to them
  touch $logfile
  chown $user $logfile

  touch $pidfile
  chown $user $pidfile

  # Launch the application
  su - $user -c "$forever start -p $forever_dir --pidFile $pidfile -l $logfile -a -d $APP $ARGS 2>&1 >/dev/null"
  ret=$?

    if [ $ret -eq 0 ]; then
        action $"Starting ${NAME}: " /bin/true
    else
        action $"Starting ${NAME}: " /bin/false
        rm -f ${SOCK_FILE}
    fi

    return $ret
}

stop() {
  su - $user -c "$forever stop -p $forever_dir $APP 2>&1 >/dev/null"
  ret=$?

  if [ $ret -eq 0 ]; then
        action $"Stopping ${NAME}: " /bin/true
        rm -f ${SOCK_FILE}
    else
        action $"Stopping ${NAME}: " /bin/false
    fi

    return $ret
}

case "$1" in
  start)
    start
    ;;
  stop)
    stop
    ;;
  restart)
    stop
    start
    ;;
  status)
    status -p ${pidfile}
    ;;
  *)
    echo "Usage:  {start|stop|restart|status}"
    exit 1
    ;;
esac
exit $RETVAL
